<div id="chatbot-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <!-- Chat Icon -->
    <div id="chatbot-icon"
        style="background-color: #2961eb; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
        <i class="ri-chat-smile-2-line" style="font-size: 30px;"></i>
    </div>

    <!-- Chat Window -->
    <div id="chat-window"
        style="display: none; position: absolute; bottom: 70px; right: 0; width: 350px; height: 500px; background-color: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-direction: column; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        <!-- Header -->
        <div
            style="background-color: #2961eb; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: bold; font-size: 1.1em;">AI Assistant</span>
            <i class="ri-close-line" id="close-chat" style="cursor: pointer; font-size: 20px;"></i>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages"
            style="flex: 1; padding: 15px; overflow-y: auto; background-color: #f9f9f9; display: flex; flex-direction: column; gap: 10px;">
            <div
                style="align-self: flex-start; background-color: #e0e0e0; padding: 10px; border-radius: 10px 10px 10px 0; max-width: 80%;">
                Hello! How can I help you today?
            </div>
        </div>

        <!-- Input Area -->
        <div style="padding: 15px; border-top: 1px solid #ddd; background-color: white; display: flex; gap: 10px;">
            <input type="text" id="chat-input" placeholder="Type a message..."
                style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
            <button id="send-btn"
                style="background-color: #2961eb; color: white; border: none; padding: 10px 15px; border-radius: 50%; cursor: pointer;">
                <i class="ri-send-plane-fill"></i>
            </button>
        </div>
    </div>
</div>

<script>
    const chatbotIcon = document.getElementById('chatbot-icon');
    const chatWindow = document.getElementById('chat-window');
    const closeChat = document.getElementById('close-chat');
    const sendBtn = document.getElementById('send-btn');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');

    // Toggle Chat Window
    chatbotIcon.addEventListener('click', () => {
        chatWindow.style.display = chatWindow.style.display === 'none' || chatWindow.style.display === '' ? 'flex' : 'none';
        if (chatWindow.style.display === 'flex') {
            chatInput.focus();
        }
    });

    closeChat.addEventListener('click', () => {
        chatWindow.style.display = 'none';
    });

    // Send Message Logic
    function sendMessage() {
        const message = chatInput.value.trim();
        if (message === "") return;

        // Add User Message
        appendMessage(message, 'user');
        chatInput.value = '';

        // Show loading indicator
        const loadingId = 'loading-' + Date.now();
        appendMessage('Typing...', 'bot', loadingId);

        // Send to Backend
        fetch('/chat_api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Add CSRF token if not handled by @csrf_exempt or if needed for other protections
            },
            body: JSON.stringify({ message: message })
        })
            .then(response => response.json())
            .then(data => {
                // Remove loading indicator
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) loadingElement.remove();

                if (data.response) {
                    appendMessage(data.response, 'bot');
                } else if (data.error) {
                    appendMessage("Error: " + data.error, 'bot');
                } else {
                    appendMessage("Sorry, something went wrong.", 'bot');
                }
            })
            .catch(error => {
                // Remove loading indicator
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) loadingElement.remove();

                console.error('Error:', error);
                appendMessage("Sorry, I couldn't connect to the server.", 'bot');
            });
    }

    sendBtn.addEventListener('click', sendMessage);

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function appendMessage(text, sender, id = null) {
        const messageDiv = document.createElement('div');
        if (id) messageDiv.id = id;

        const style = sender === 'user'
            ? 'align-self: flex-end; background-color: #2961eb; color: white; padding: 10px; border-radius: 10px 10px 0 10px; max-width: 80%;'
            : 'align-self: flex-start; background-color: #e0e0e0; color: black; padding: 10px; border-radius: 10px 10px 10px 0; max-width: 80%;';

        messageDiv.style = style;

        // Convert newlines to <br> for bot messages if needed, or just use textContent
        // Using innerHTML carefully or just textContent
        messageDiv.innerText = text;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>